<!DOCTYPE html>
<html>
    <head>
        <script src="store.js"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <title>mini KID'S CLOTHES</title>
    
        <!--the first link is for Bootstrap's designs-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <!--the second link is for Bootstrap's icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    
        <!--link for our CSS-->
        <link rel="stylesheet" href="styles.css"/>
    </head>
    <body onload="printWelcomeMessage()" >
        <section id="header"> <!-- this section is for the upper part of the page-->
            <!--importing a logo picture from the same folder-->
            <a href="#"><img src="logo5.png" class="logo" alt="" style="width: 200px"></a>
    
            <div>
                <ul id="navbar">
                    <li><a href="store.html">Home</a></li>
                    <li><a href="shop.html">Shop</a></li>
                    <!--creating icons from Bootstrap-->
                    <!--Since the software has to recognize the page without a name(but the icon) w'll have to use id-->
                    <li id="logIn"><a href="logIn.html"><i class="bi bi-person-fill"></i></a></li>
                    <li><a  class="active" href="cart.html"><i class="bi bi-bag"></i></a></li>
                </ul>
            </div>
        </section>
        <section class="container content-section">
    <p id="welcomeMessage" >Welcome!</p>
    <div class="cart-row">
        <span class="cart-item cart-header cart-column">ITEM</span>
        <span class="cart-price cart-header cart-column">PRICE</span>
        <span class="cart-quantity cart-header cart-column">QUANTITY</span>
    </div>
    <div class="cart-items">
    </div>
    <div class="cart-total">
        <strong class="cart-total-title">Total</strong>
        <span class="cart-total-price">$0</span>
    </div>
    <button class="btn btn-primary btn-purchase" type="button">PURCHASE</button>
    <button class="btn btn-secondary" id="view-orders-btn">Previous Orders</button>


</section>


  
  <script src="auth-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
  integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  
<!--script for loading cart items-->
<script>
async function loadCart() {
    const token = localStorage.getItem("token");
    const payload = JSON.parse(atob(token.split(".")[1]));
    const userId = payload.id;

    const res = await fetch(`http://localhost:3000/api/cart/${userId}`);
    const data = await res.json();

    const container = document.querySelector(".cart-items");
    container.innerHTML = "";

    data.cart.forEach(item => {
        const div = document.createElement("div");
        div.classList.add("cart-row");

      div.innerHTML = `
    <div class="cart-item cart-column">
        <img class="cart-item-image" src="${item.productId.imageUrl}" width="100">
        <span class="cart-item-title">${item.productId.title}</span>
    </div>

    <span class="cart-price cart-column">$${item.productId.price}</span>
    <div class="cart-quantity cart-column">
    <button class="qty-btn decrease-qty" data-id="${item.productId._id}">-</button>
    <span class="item-qty">${item.quantity}</span>
    <button class="qty-btn increase-qty" data-id="${item.productId._id}">+</button>

    <button class="remove-item-btn" data-id="${item.productId._id}">Remove</button>
</div>

   
`;
    container.appendChild(div);
    });
    // Calculate total
let total = 0;
data.cart.forEach(item => {
    total += item.productId.price * item.quantity;
});
document.querySelector(".cart-total-price").innerText = "$" + total;

}

document.addEventListener("DOMContentLoaded", loadCart);
</script>

<!-- ORDERS MODAL -->
<div id="ordersModal" class="modal-overlay">
  <div class="modal-box">
    <h2>Your Previous Orders</h2>

    <div id="orders-list"></div>

    <button class="close-btn" id="closeOrdersModal">Close</button>
  </div>
</div>

<script>
document.getElementById("view-orders-btn").addEventListener("click", loadOrders);
document.getElementById("closeOrdersModal").addEventListener("click", () => {
    document.getElementById("ordersModal").style.display = "none";
});


// Load and display previous orders
async function loadOrders() {
    const token = localStorage.getItem("token");
    const payload = JSON.parse(atob(token.split(".")[1]));
    const userId = payload.id;

    const res = await fetch(`http://localhost:3000/api/orders/${userId}`);
    const data = await res.json();

    const container = document.getElementById("orders-list");
    container.innerHTML = "";

    if (data.orders.length === 0) {
        container.innerHTML = "<p>No previous orders found.</p>";
    }

    data.orders.forEach(order => {
        const div = document.createElement("div");
        div.classList.add("order-item");

        const date = new Date(order.createdAt).toLocaleString();

        let itemsHtml = "";
        order.items.forEach(i => {
            itemsHtml += `
              <div>
                <strong>${i.productId.title}</strong>  
                — ${i.quantity} × $${i.price}
              </div>`;
        });

        div.innerHTML = `
          <div class="single-order">
            <h4>Order on: ${date}</h4>
            ${itemsHtml}
            <p><strong>Total: $${order.totalPrice}</strong></p>
          </div>
          <hr>
        `;

        container.appendChild(div);
    });

    document.getElementById("ordersModal").style.display = "flex";
}
</script>


<!-- PURCHASE BUTTON SCRIPT -->
<script>
document.querySelector(".btn-purchase").addEventListener("click", async () => {
    const token = localStorage.getItem("token");
    const payload = JSON.parse(atob(token.split(".")[1]));
    const userId = payload.id;

    const res = await fetch("http://localhost:3000/api/orders/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
    });

    alert("Thank you for your purchase!");
    loadCart(); 
});
</script>



<!-- REMOVE ITEM FROM CART SCRIPT -->
<script>
document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("remove-item-btn")) {
        
        const productId = e.target.getAttribute("data-id");

        const token = localStorage.getItem("token");
        const payload = JSON.parse(atob(token.split(".")[1]));
        const userId = payload.id;

        await fetch("http://localhost:3000/api/cart/remove", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, productId })
        });

        alert("Product removed from cart");         loadCart(); 
    }
});
</script>

<!-- INCREASE/DECREASE QUANTITY SCRIPT -->
<script>
document.addEventListener("click", async (e) => {
    const token = localStorage.getItem("token");
    if (!token) return;

    const payload = JSON.parse(atob(token.split(".")[1]));
    const userId = payload.id;

    
    if (e.target.classList.contains("increase-qty")) {
        const productId = e.target.getAttribute("data-id");

        await fetch("http://localhost:3000/api/cart/increase", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, productId })
        });

        loadCart();
    }

    if (e.target.classList.contains("decrease-qty")) {
        const productId = e.target.getAttribute("data-id");

        await fetch("http://localhost:3000/api/cart/decrease", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, productId })
        });

        loadCart();
    }
});
</script>


</body>
</html>